version: '3.8'

services:
  forgelens-api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_DEPLOYMENT=${AZURE_OPENAI_DEPLOYMENT:-gpt-4o}
      - AZURE_OPENAI_DALLE_DEPLOYMENT=${AZURE_OPENAI_DALLE_DEPLOYMENT:-dall-e-3}
      - OUTPUT_DIRECTORY=/app/artifacts/images
      - NEWS_API_KEY=${NEWS_API_KEY:-}
      - GNEWS_API_KEY=${GNEWS_API_KEY:-}
      - NEWSDATA_API_KEY=${NEWSDATA_API_KEY:-}
      - INSTAGRAM_USERNAME=${INSTAGRAM_USERNAME:-}
      - INSTAGRAM_PASSWORD=${INSTAGRAM_PASSWORD:-}
    volumes:
      - ./artifacts:/app/artifacts
      - ~/.azure:/root/.azure:ro  # For Azure CLI credentials
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

networks:
  default:
    name: forgelens-network
